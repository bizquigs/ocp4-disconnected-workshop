= Setup the High Side

In this lab we will setup the [.highside]#highside# system.
Recall from the architecture diagram (below) that you will configure the [.highside]#highside# system to run an _image registry_ inside the disconnected network.
We'll use OpenShift's `mirror-registry` as our _image registry_.
The `mirror-registry` is a simplified version of Red Hat's Quay Image Registry.
You can use any _image registry_ you like, as long as it supports the Docker v2 API, [.underline]#uses TLS encryption, and requires authenticated image pulls#.
Examples of alternative _image registries_ include.

* Harbor
* JFrog Artifactory
* Sonatype Nexus Repository
* Red Hat Quay Registry (enterprise)

== Lab Overview

The tasks in this lab include:

{counter:overview}. Transfering the installation content to the [.highside]#highside# system using `rsync`

{counter:overview}. Connecting to the [.highside]#highside# system and proving that its disconnected

{counter:overview}. Installing the `mirror-registry`

* Trusting the generated TLS certificate
* Logging in and creating a _pull secret_

{counter:overview}. Uploading the `.tar` file's contents into the `mirror-registry`


== Out-of-Order operations

In order to make good use of our time together, we will perform the tasks described above out-of-order.
We will start by copying the `mirror-registry` file from the [.lowside]#lowside# system onto the [.highside]#highside# system.
Next, we will log into the [.highside]#highside# system to install the `mirror-registry`.
While the `mirror-registry` installs itself (5 minutes), we will demonstrate that the [.highside]#highside# system is disconnected.
The `oc-mirror` download command (15 minutes) should be finished by the time we finish those tasks.
We will end this section by transfering the 25GB `.tar` file and uploading its contents into the `mirror-registry`

== Creating a Mirror Registry

Let's begin by using the `rsync` command to copy the `mirror-registry` file from the [.lowside]#lowside# system onto the [.highside]#highside# system. Please run this command in the other `tmux` pane.

[.lowside,source,bash,role=execute,subs="attributes"]
----
rsync -avP /mnt/low-side-data/mirror-registry.tar.gz highside:/mnt/high-side-data/
----
[.output]
----
Warning: Permanently added 'highside' (ED25519) to the list of known hosts.
sending incremental file list
mirror-registry.tar.gz
    706,802,330 100%  133.34MB/s    0:00:05 (xfr#1, to-chk=0/1)

sent 706,975,008 bytes  received 35 bytes  128,540,916.91 bytes/sec
total size is 706,802,330  speedup is 1.00
----

Great! Now its time to log into the [.highside]#highside# system.

=== Logging into the highside system

In the real world, customers often access their disconnected systems using a VPN, a jump server, or with dedicated workstations.
In your workshop environment, an exception was created in the firewall that allows (only) the [.lowside]#jump system# to SSH to the [.highside]#highside# system.

Password-less SSH has been enabled for your convenience.
Please log into the [.highside]#highside# system using `ssh` from the [.lowside]#jump# system.

[.lowside,source,bash,role=execute,subs="attributes"]
----
ssh highside
----
[.output]
----
Warning: Permanently added 'highside' (ED25519) to the list of known hosts.
Last login: Wed May  1 07:56:13 2024 from 10.0.6.23
[lab-user@highside ~]$
----

Now that the [.highside]#highside# system has the mirroring tools and installation content transferred, we can setup the `mirror-registry`.
We need to change directories and extract the `mirror-registry` files first.

[.highside,source,bash,role=execute]
----
cd /mnt/high-side-data
tar -xzvf mirror-registry.tar.gz
----
[.output]
----
image-archive.tar
execution-environment.tar
mirror-registry
----

Now we install the `mirror-registry` and set a password for the initial user.
The automation that installs and configures the `mirror-registry` takes ~5 minutes to complete.
Unfortunately we can't move on to the next step of trusting the TLS certificate until the `mirror-registry` has finished installing.

[.highside,source,bash,role=execute]
----
./mirror-registry install --initPassword discopass
----
[.output]
----
...
INFO[2023-07-06 15:43:41] Quay installed successfully, config data is stored in /home/lab-user/quay-install
INFO[2023-07-06 15:43:41] Quay is available at https://ip-10-0-51-47.ec2.internal:8443 with credentials (init, discopass)
----

[NOTE]
The `mirror-registry` is installed with a TLS certificate that is not trusted by anything, not even the [.highside]#highside# system where it was installed.

The procedure to trust the `mirror-registry` TLS certificate is simple.
Copy the Certificate Authority file (rootCA.pem) into the Red Hat Enterprise Linux CA trust directory.
Then run the `update-ca-trust` command.

[.highside,source,bash,role=execute]
----
sudo cp -v /home/lab-user/quay-install/quay-rootCA/rootCA.pem /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust
----

After the `mirror-registry` TLS certificate has been trusted, use `podman` to login.
The username is `init` and the password `discopass`.

[.highside,source,bash,role=execute]
----
podman login -u init -p discopass $(hostname):8443
----
[.output]
----
Login Succeeded!
----

The `podman login` command creates an authentication file / (_pull secret_) at `/run/user/1000/containers/auth.json`.
Note that the `oc-mirror` command looks for _pull secrets_ in multiple locations:

* `$HOME/.docker/config.json` (created on the [.lowside]#lowside jump# system)
* `$XDG_RUNTIME_DIR/containers/auth.json` (created on the [.highside]#highside# system)

== Moving the installation content onto `highside`

[WARNING]
Make sure that your `oc mirror` command has completed successfully before proceeding.
You can confirm the mirroring has finished by looking in your `tmux` pane to see if your prompt has returned.

[.output]
----
...
info: Mirroring completed in 2m47.63s (135.1MB/s)
Creating archive /mnt/low-side-data/mirror_seq1_000000.tar
[lab-user@jump low-side-data]$ 
----

After the `oc-mirror` command has completed, use `rsync` on the [.lowside]#jump# system to copy the installation content into `/mnt/high-side-data` on the [.highside]#highside# system.

[WARNING]
--
Please run the `rsync` command in your `tmux` screen.
This will allow you to keep working on the next section while `rsync` moves ~25 GB of data.
The `rsync` tasks should complete in about 5 minutes.
--

[.lowside,source,bash,role=execute,subs="attributes"]
----
rsync -avP /mnt/low-side-data/ highside:/mnt/high-side-data/
----
[.output]
----
...
publish/
publish/.metadata.json
        332,183 100%  332.37kB/s    0:00:00 (xfr#66, to-chk=0/127)

sent 30,795,621,525 bytes  received 1,565 bytes  131,324,618.72 bytes/sec
total size is 30,788,095,434  speedup is 1.00
----

== Prove that highside is disconnected

Looking at the workshop environment diagram, we can see how the [.highside]#highside# system is disconnected.

image::disco-5.svg[disco diagram,800]

[NOTE]
--
The [.highside]#highside systems# are configured to use a `nat / squid proxy` server to access a few resources

{counter:exceptions}. The [.highside]#highside# system allows inbound SSH connections from the [.lowside]#jump system#

{counter:exceptions}. The [.highside]#highside# system is allowed to install RHEL RPMs from the repos inside the Amazon AWS Cloud (not from the public repos at https://cdn.redhat.com)

{counter:exceptions}. Your [.highside]#openshift.demo.lab# cluster will be allowed to talk to the Amazon AWS Cloud APIs. More details about this permission will be provided in the next lab

{counter:exceptions}. ðŸ›‘ **nothing else** ðŸ›‘ is allowed into or out of the [.highside]#highside network#

The xref:appendix01.adoc[Appendix] has more information about the `nat / squid` proxy configuration.
--

Please use the following commands to prove that the [.highside]#highside# system is unable to connect to [.underline]#openshift.com# and [.underline]#quay.io#.

You may recall that:

* The `oc` and `openshift-install` tools were downloaded from [.underline]#openshift.com#
* The OpenShift installation images were downloaded from [.underline]#quay.io#

If you try to access a blocked website, [.underline]#quay.io#, you'll see an **Acces Denied** message like this.

[.highside,source,bash,role=execute]
----
curl -I quay.io
----
[.output]
----
HTTP/1.1 403 Forbidden
Server: squid/5.5
Date: Mon, 29 Apr 2024 20:08:15 GMT
X-Squid-Error: ERR_ACCESS_DENIED 0
----

The [.highside]#highside# system is configured to install RPMs (like `podman`) from the Red Hat Update Infrastructure (RHUI) repos inside the Amazon AWS Cloud.
The output for an allowed website, like that repo, will look similar to this:
[.highside,source,bash,role=execute]
----
curl -I --insecure https://rhui.us-east-2.aws.ce.redhat.com
----
[.output]
----
HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Mon, 29 Apr 2024 20:15:51 GMT
----

== Mirroring Content

Now that the [.highside]#highside# system trusts the `mirror-registry's` TLS certificate, and `podman` has logged in and created a new _pull secret_, we're ready to upload the installation images from the `.tar`` file.

We'll begin by adding the `oc`, `oc-mirror` and `openshift-install` commands to the PATH.

[.highside,source,bash,role=execute]
----
sudo mv -v /mnt/high-side-data/oc /bin/
sudo mv -v /mnt/high-side-data/oc-mirror /bin/
sudo mv -v /mnt/high-side-data/openshift-install /bin/
----

[WARNING]
--
Please run the next `oc-mirror` command in your `tmux` screen.
This will allow you to keep working on the next section while `oc-mirror` uploads ~25 GB of data into the `mirror-registry`.
The `oc-mirror` task should complete in about 15 minutes.
--

[.highside,source,bash,role=execute]
----
oc mirror --from=/mnt/high-side-data/mirror_seq1_000000.tar docker://$(hostname):8443
----
[.output]
----
...

info: Mirroring completed in 18m10.33s (39.33MB/s)
Rendering catalog image "ip-10-0-8-121.us-west-2.compute.internal:8443/redhat/redhat-operator-index:v4.14" with file-based catalog 
Writing image mapping to oc-mirror-workspace/results-1714533240/mapping.txt
Writing UpdateService manifests to oc-mirror-workspace/results-1714533240
Writing CatalogSource manifests to oc-mirror-workspace/results-1714533240
Writing ICSP manifests to oc-mirror-workspace/results-1714533240

[lab-user@highside ~]$ 
----

[TIP]
--
You can click the *Desktop* button and use Firefox to login to your new `mirror-registry`.
You can even see the OpenShift installation images begin to appear.
Don't spend too much time exploring the `mirror-registry's` web pages.
We need to start the next section, **Installing OpenShift**
--

image::vnc-disco-registry-bookmark.png[Desktop / VNC button]

//TODO get the user out of tmux!
